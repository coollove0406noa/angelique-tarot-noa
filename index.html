<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angelique Tarot (CSVç‰ˆ)</title>
  <style>
    :root{
  --bg:#666132;
  --text:#ffffff;                 /* æ–‡å­—ã¯ç™½ç³»ã« */
  --muted:rgba(231, 206, 233, 0.72);  /* è£œåŠ©æ–‡å­— */
  --line:rgba(133, 45, 45, 0.14);

  --accent:#f0abfc;   /* å¤©ä½¿ãƒ”ãƒ³ã‚¯ */
  --accent2:#a5b4fc;  /* ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */

  --good:#86efac;
  --warn:#fde68a;
  --bad:#fda4af;
}


    *{box-sizing:border-box}
 body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;

  background:
    linear-gradient(rgba(14,11,22,.62), rgba(14,11,22,.62)),
    url("bg/angel_bg1.webp") center / cover no-repeat,
    var(--bg);

  color: var(--text);
  min-height:100vh;
}




    .app{width:min(1100px, 100%)}
    header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:14px;}
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h1{margin:0; font-size:30px; letter-spacing:.04em;}
    .title p{margin:0; color:var(--muted); font-size:22px; line-height:1.4;}

    .panel{
  background: rgba(20, 16, 30, .62);   /* åŠé€æ˜ã®é—‡ */
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  border:1px solid rgba(255,255,255,.25);
  border-radius:18px;
  padding:14px;

  box-shadow:
    0 14px 40px rgba(0,0,0,.45),
    inset 0 0 0 1px rgba(255,255,255,.12);
}


    .topGrid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;}
    @media (max-width: 980px){
  .cardsGrid{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 980px){
  .cardsGrid{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 520px){
  .cardsGrid{ grid-template-columns: repeat(3, 1fr); gap:10px; }
  .cardImg{ width: 160px; }
}


.drawMode{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  border-radius:999px;
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, background .12s ease;
}
.chip:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
.chip input{accent-color:var(--accent); margin:0}
.chip strong{font-size:13px}
.chip span{font-size:12px; color:var(--muted)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    button{
      border:0; cursor:pointer;
      padding:12px 14px; border-radius:14px;
      color:var(--text);
      background: linear-gradient(135deg, rgba(167,139,250,.9), rgba(96,165,250,.9));
      font-weight:700;
      letter-spacing:.02em;
      box-shadow: 0 10px 25px rgba(96,165,250,.14);
      transition:transform .12s ease, filter .12s ease;
    }
    button:hover{transform:translateY(-1px); filter:saturate(1.05)}
    button.secondary{
       background: linear-gradient(
    135deg,
    rgba(240,171,252,.95),
    rgba(165,180,252,.95)
  );
  box-shadow:
    0 10px 30px rgba(165,180,252,.25),
    inset 0 0 0 1px rgba(255,255,255,.25);
}
    button.secondary:hover{color:var(--text); background:rgba(255,255,255,.09)}
    .status{margin-top:10px; color:var(--muted); font-size:12px;}

    .stage{margin-top:12px; padding:14px;}
    .stageTop{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px;}
    .stageTitle{display:flex; flex-direction:column; gap:2px;}
    .stageTitle h2{margin:0; font-size:16px;}
    .stageTitle p{margin:0; font-size:12px; color:var(--muted);}

    .shuffleArea{
      position:relative; height:140px; border-radius:16px;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.15));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .deck{
  position:absolute; left:50%; top:50%;
  width:200px; height:200px;
  transform:translate(-50%,-50%);
  border-radius:30px;
  overflow:hidden;

  /* â˜…è£é¢ç”»åƒã‚’è¡¨ç¤º */
  background: url("cards/back.png") center / cover no-repeat;

  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
}

/* æ–‡å­—ãƒ­ã‚´ã¯æ¶ˆã—ãŸã„ãªã‚‰ã“ã®ã¾ã¾å‰Šé™¤ã—ã¦OK */
.deck::after{
  content:"";
}

/* é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼ˆè£é¢ï¼‰ */
.fly{
  position:absolute; width:130px; height:185px;
  border-radius:20px;
  overflow:hidden;

  /* â˜…è£é¢ç”»åƒã‚’è¡¨ç¤º */
  background: url("cards/back.png") center / cover no-repeat;

  border:1px solid rgba(255,255,255,.15);
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  opacity:0;
  box-shadow: 0 16px 30px rgba(0,0,0,.35);
}

    .shuffling .deck{
  animation: deckBreath 1.8s ease-in-out infinite;
}

@keyframes deckBreath{
  0%,100%{
    transform:translate(-50%,-50%) scale(1) rotate(0deg);
    box-shadow: 0 18px 40px rgba(0,0,0,.45),
                0 0 22px rgba(200,160,255,.35);
  }
  50%{
    transform:translate(-50%,-50%) scale(1.05) rotate(2deg);
    box-shadow: 0 22px 60px rgba(0,0,0,.55),
                0 0 38px rgba(160,200,255,.55);
  }
}



    .cardsGrid{margin-top:14px; display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;}
  .cardsGrid.single{
  grid-template-columns: 1fr;
  justify-items: center;
}

.cardsGrid.three{
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;                 /* ä½™ç™½å°‘ãªã‚ */
  align-items: start;
  justify-items: center;
}

/* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ï¼ˆå¥½ã¿ã§ï¼‰ */
.cardsGrid.three .tcard:nth-child(2).cardImg{
  width: 280px;      /* â† åŸºæœ¬ã‚µã‚¤ã‚º */
  max-width: 90%;
}


@media (max-width: 520px){
  .cardImg{ width: 170px; }
  .cardsGrid.three .tcard:nth-child(2) .cardImg{ width: 261
    0px; }
}
/* === æ–‡å­—ã®å¯èª­æ€§ã‚’ä¸Šã’ã‚‹é­”æ³• === */
body,
.panel,
.tcard,
.stage,
header,
.status,
.small,
.empty{
  text-shadow:
    0 1px 2px rgba(0,0,0,.55),
    0 0 6px rgba(0,0,0,.35);
}

    .tcard{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      overflow:hidden;
      box-shadow:
    0 12px 34px rgba(0,0,0,.35),
    0 0 0 1px rgba(255,255,255,.12),
    0 0 28px rgba(240,171,252,.15); /* å…‰ */
}
    .tcardHeader{
      display:flex; justify-content:space-between; gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .tcardTitle{display:flex; flex-direction:column; gap:3px;}
    .tcardTitle .pos{font-size:12px; color:rgba(255,255,255,.78); letter-spacing:.06em;}
    .tcardTitle .name{font-size:14px; font-weight:800; line-height:1.2;}
    .tcardTitle .sub{font-size:12px; color:var(--muted); font-weight:600;}

    .badge{
      align-self:flex-start;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .badge.up{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12)}
    .badge.rev{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12)}

    .tcardVisual{padding:12px; display:flex; justify-content:center;}
    /* çµæœã‚«ãƒ¼ãƒ‰ï¼ˆtcardï¼‰å†…ã®ç”»åƒ */
    /* çµæœã‚«ãƒ¼ãƒ‰ï¼ˆtcardï¼‰å†…ã®ç”»åƒ */
    /* === â‘¡-1 çµæœã‚«ãƒ¼ãƒ‰ç”»åƒã‚’å¤§ãã === */
/* ===== cardImg ã¯ã“ã“ã§ä¸€æ‹¬ç®¡ç†ï¼ˆæœ€å¾Œã«ç½®ãï¼‰ ===== */
.cardImg{
  width: 340px;              /* 3æšã™ã¹ã¦å¤§ãã */
  max-width: 92%;
  height: auto;
  display:block;
  aspect-ratio: 2 / 3;
  object-fit: cover;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.22);
  box-shadow: 0 22px 46px rgba(0,0,0,.45);
}
.cardImg.reversed{ transform: rotate(180deg); }

/* 3æšå¼•ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.cardsGrid.three{
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  justify-items: center;
  align-items: start;
}

/* çœŸã‚“ä¸­ã ã‘â€œã•ã‚‰ã«â€å¼·èª¿ï¼ˆä»»æ„ã€‚è¦ã‚‰ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰ */
.cardsGrid.three .tcard:nth-child(2) .cardImg{
  width: 360px;
}

/* 1æšå¼•ã */
.cardsGrid.single{
  grid-template-columns: 1fr;
  justify-items: center;
}

/* ã‚¹ãƒãƒ›èª¿æ•´ */
@media (max-width: 480px){
  .cardsGrid.three{ gap: 10px; }
  .cardImg{ width: 20vw; } /* 3æšæ¨ªã§åã¾ã‚‹ */
  .cardsGrid.three .tcard:nth-child(2) .cardImg{ width: 34vw; }
}



    .face{
      width:128px; height:188px;
      border-radius:18px;
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(167,139,250,.30), transparent 60%),
        radial-gradient(140px 110px at 70% 80%, rgba(96,165,250,.22), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 30px rgba(0,0,0,.40);
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
      transition: transform .2s ease;
    }
    .face .mono{position:absolute; top:10px; left:10px; font-size:11px; color:rgba(255,255,255,.7); letter-spacing:.1em;}
    .face .big{font-size:12px; font-weight:800; letter-spacing:.08em; color:rgba(255,255,255,.86); text-align:center; padding:0 12px; line-height:1.25;}
    .face.reversed{transform: rotate(180deg);}

    .tcardBody{padding: 0 12px 12px; color:rgba(255,255,255,.90); font-size:13px; line-height:1.62;}
    .line{padding:10px 0; border-top:1px solid rgba(255,255,255,.08);}
    .line:first-child{border-top:0}
    .k{color:rgba(255,255,255,.90); font-weight:900; margin-right:6px;}

    /* Keyword chips */
    .kwWrap{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .kw{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .kw.rev{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.10)}
    .kw.up{border-color:rgba(96,165,250,.25); background:rgba(96,165,250,.10)}

    details{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:10px 12px;
      color: rgba(255,255,255,.88);
      font-weight:800;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none;}
    .detailsBody{padding:0 12px 12px; color:rgba(255,255,255,.86); font-size:12.5px; line-height:1.6;}
    .note{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.10);
      color: rgba(255,255,255,.88);
      font-size:12px;
      line-height:1.55;
    }
    .empty{
      padding:14px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      background: rgba(0,0,0,.12);
    }
    .small{font-size:12px; color:var(--muted);}
/* ===== Yes / No è¡¨ç¤ºã‚’å¤§ããã™ã‚‹ ===== */
.ynRow{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

.yn{
  font-size:16px;        /* â† å¤§ãã•ï¼ˆã“ã“ã‚’18ã‚„20ã«ã—ã¦ã‚‚OKï¼‰ */
  font-weight:900;
  padding:10px 14px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.4);
  background: rgba(255,255,255,.15);
}

.yn.up{
  border-color: #4ade80;
  background: rgba(74,222,128,.25);
}

.yn.rev{
  border-color: #facc15;
  background: rgba(250,204,21,.25);
}
.cardWrap{
  display:flex;
  justify-content:center;
  margin-top:18px;
}

/* 1æšå¼•ãã®è¡¨ç¤ºï¼ˆä¸Šã®1æšã ã‘å‡ºã‚‹ã‚«ãƒ¼ãƒ‰ï¼‰ */
.cardWrap{
  display:flex;
  justify-content:center;
  margin-top:18px;
}
.cardFrame{
  width: min(360px, 78vw);   /* ä¸­å¤®ã§å¤§ãã‚ */
}
#tarotCard.tarotCard{
  width: 100%;
  height: auto;
  display:block;
  aspect-ratio: 2 / 3;       /* å´©ã‚Œé˜²æ­¢ */
  object-fit: cover;
  border-radius:18px;
  box-shadow: 0 16px 30px rgba(0,0,0,.40);
  border:1px solid rgba(255,255,255,.18);
}

/* é€†ä½ç½®ï¼šå›è»¢ã ã‘ã§OKï¼ˆtranslateã¯ä¸è¦ï¼‰ */
#tarotCard.tarotCard.reversed{
  transform: rotate(180deg);
}
/* === å¼·åˆ¶ãƒ†ã‚­ã‚¹ãƒˆå¯è¦–åŒ–ï¼ˆå¿œæ€¥ï¼‰ === */
/* å¿œæ€¥ã®å¼·åˆ¶ã¯æœ€å°é™ã« */
body{ color: var(--text); }


/* ===== è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæœ€çµ‚æ±ºå®šç‰ˆï¼‰ ===== */
.cardsGrid{
  margin-top:14px;
  display:grid;
  gap:16px;
}

.cardsGrid.single{
  grid-template-columns: 1fr;
  justify-items:center;
}

.cardsGrid.three{
  grid-template-columns: repeat(3, 1fr);
  justify-items:center;
  align-items:start;
}

/* ç”»åƒã‚µã‚¤ã‚ºï¼ˆå…¨ä½“ï¼‰ */
.cardImg{
  width: min(360px, 28vw); /* 3æšã¨ã‚‚å¤§ãã„ */
  max-width: 92%;
  height:auto;
  display:block;
  aspect-ratio: 2 / 3;
  object-fit: cover;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:
    0 18px 44px rgba(0,0,0,.45),
    0 0 36px rgba(240,171,252,.12);
}
.cardImg.reversed{ transform: rotate(180deg); }

/* çœŸã‚“ä¸­ã ã‘ã»ã‚“ã®å°‘ã—å¼·èª¿ï¼ˆä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰ */
.cardsGrid.three .tcard:nth-child(2) .cardImg{
  width: min(400px, 32vw);
}

/* ãƒ¢ãƒã‚¤ãƒ« */
@media (max-width: 480px){
  .cardsGrid.three{ gap:10px; }
  .cardImg{ width: 30vw; }
  .cardsGrid.three .tcard:nth-child(2) .cardImg{ width: 34vw; }
}
ã€€ã€€/* === ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼šå…‰ã®ã‚ªãƒ¼ãƒ© === */
.shuffleArea::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(200,160,255,.35),
      rgba(160,200,255,.18),
      transparent 60%);
  opacity:.6;
  animation: auraPulse 2.8s ease-in-out infinite;
  pointer-events:none;
}

@keyframes auraPulse{
  0%,100%{ transform: scale(1); opacity:.45 }
  50%{ transform: scale(1.08); opacity:.75 }
}
/* === é£›ã¶ã‚«ãƒ¼ãƒ‰ã®å‹•ãã‚’å„ªé›…ã«ã™ã‚‹ === */
.shuffling .fly{
  animation-timing-function: cubic-bezier(.22,.61,.36,1);
}
/* ===== ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆã“ã“ã ã‘è§¦ã‚Œã°OKï¼‰===== */
:root{
  --deck-size: 240px;     /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­å¤®ã®æŸï¼ˆå¤§ããï¼‰ */
  --fly-w: 160px;         /* é£›ã¶ã‚«ãƒ¼ãƒ‰å¹…ï¼ˆå¤§ããï¼‰ */
  --fly-h: 230px;         /* é£›ã¶ã‚«ãƒ¼ãƒ‰é«˜ã•ï¼ˆå¤§ããï¼‰ */

  --result-w-1: min(300px, 78vw); /* 1æšå¼•ãã®çµæœï¼ˆå°‘ã—å°ã•ãï¼‰ */
  --result-w-3: min(240px, 26vw); /* 3æšå¼•ãã®çµæœï¼ˆå°ã•ãï¼‰ */
  --result-w-3-mid: min(260px, 28vw); /* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ */
}

/* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¨ãƒªã‚¢é«˜ã•ã‚‚å°‘ã—ä¸Šã’ã‚‹ï¼ˆå¤§ããã—ãŸåˆ†ã®ä½™è£•ï¼‰ */
.shuffleArea{
  height: 220px;
}

/* ä¸­å¤®ãƒ‡ãƒƒã‚­ï¼ˆæŸï¼‰ */
.deck{
  width: var(--deck-size) !important;
  height: var(--deck-size) !important;
  border-radius: 28px;
}

/* é£›ã¶ã‚«ãƒ¼ãƒ‰ */
.fly{
  width: var(--fly-w) !important;
  height: var(--fly-h) !important;
  border-radius: 22px;
}

/* çµæœï¼š3æšå¼•ãï¼ˆã„ã¾ cardImg ãŒå¤§ãã™ãã‚‹ã®ã§ä¸‹ã’ã‚‹ï¼‰ */
.cardsGrid.three .cardImg{
  width: var(--result-w-3) !important;
  max-width: 100%;
}

/* çµæœï¼šçœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ï¼ˆä»»æ„ï¼‰ */
.cardsGrid.three .tcard:nth-child(2) .cardImg{
  width: var(--result-w-3-mid) !important;
}

/* çµæœï¼š1æšå¼•ãï¼ˆ#tarotCard ã¯ä»Šä½¿ã£ã¦ãªã„ã‘ã©ä¿é™ºã§ï¼‰ */
.cardsGrid.single .cardImg{
  width: var(--result-w-1) !important;
  max-width: 100%;
}

/* ã‚¹ãƒãƒ›ï¼š3æšæ¨ªä¸¦ã³ã®å´©ã‚Œé˜²æ­¢ */
@media (max-width: 480px){
  .shuffleArea{ height: 200px; }
  :root{
    --result-w-3: 28vw;
    --result-w-3-mid: 32vw;
  }
}

/* ===== ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼šãƒ‡ãƒƒã‚­ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦è‡ªå‹•ã§åºƒã’ã‚‹ ===== */
:root{
  /* ã™ã§ã«å…¥ã‚Œã¦ã‚‹ãªã‚‰ã“ã“ã¯åˆã‚ã›ã‚‹ã ã‘ã§OK */
  --deck-size: 240px;
}

/* deck ãŒå¤§ãããªã£ã¦ã‚‚åˆ‡ã‚Œãªã„é«˜ã•ã«ã™ã‚‹ */
.shuffleArea{
  height: calc(var(--deck-size) + 80px) !important; /* â† ä½™ç™½ã¶ã‚“å¢—ã‚„ã™ */
  min-height: 220px;
  overflow: hidden; /* æ¼”å‡ºã‚’æ å†…ã«åã‚ãŸã„ãªã‚‰ hidden ã®ã¾ã¾ã§OK */
}

/* ã‚¹ãƒãƒ›ã¯å°‘ã—æ§ãˆã‚ã« */
@media (max-width: 520px){
  .shuffleArea{
    height: calc(var(--deck-size) + 60px) !important;
    min-height: 200px;
  }
}
/* ã‚¯ãƒªãƒƒã‚¯ãŒå¸ã‚ã‚Œã‚‹ã®ã‚’é˜²ãï¼ˆè¶…é‡è¦ï¼‰ */
.shuffleArea,
.shuffleArea *{
  pointer-events: none;
}

/* ãƒœã‚¿ãƒ³ã¯å¿…ãšæŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
#btnDraw{
  pointer-events: auto;
  position: relative;
  z-index: 10;
}
:root{
  --deck-w: 220px;          /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼šå¹… */
  --deck-h: 320px;          /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼šé«˜ã•ï¼ˆã‚«ãƒ¼ãƒ‰æ¯”ç‡ã«ï¼‰ */
  --deck-radius: 22px;      /* è§’ä¸¸ */
}

/* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ç®±ã‚’ã€Œã‚«ãƒ¼ãƒ‰é«˜ã• + ä½™ç™½ã€ã« */
.shuffleArea{
  height: calc(var(--deck-h) + 80px) !important;
  min-height: calc(var(--deck-h) + 80px) !important;
  overflow: hidden;
}
.deck{
  width: var(--deck-w) !important;
  height: var(--deck-h) !important;
  border-radius: var(--deck-radius) !important;
  background: url("cards/back.png") center / cover no-repeat;
}
.fly{
  width: calc(var(--deck-w) * 0.72) !important;
  height: calc(var(--deck-h) * 0.72) !important;
  border-radius: calc(var(--deck-radius) * 0.95) !important;
  background: url("cards/back.png") center / cover no-repeat;
}
/* ===== ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸã‚’ã€Œã‚«ãƒ¼ãƒ‰æ¯”ç‡(2:3)ã€ã§å›ºå®šã—ã¦ã€ã„ã³ã¤ã‚’è§£æ¶ˆ ===== */
:root{
  --shuffle-w: 220px;     /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚«ãƒ¼ãƒ‰ã®å¹…ï¼ˆå¤§ãã•ã¯ã“ã“ï¼‰ */
  --shuffle-r: 22px;      /* è§’ä¸¸ */
}

/* ç®±ã‚‚ã‚«ãƒ¼ãƒ‰é«˜ã•ã«åˆã‚ã›ã¦ç¢ºä¿ï¼ˆåˆ‡ã‚Œé˜²æ­¢ï¼‰ */
.shuffleArea{
  height: calc(var(--shuffle-w) * 1.5 + 90px) !important; /* 1.5 = 3/2 */
  min-height: calc(var(--shuffle-w) * 1.5 + 90px) !important;
  overflow: hidden;
}

/* ä¸­å¤®ã®æŸï¼ˆdeckï¼‰ */
.deck{
  width: var(--shuffle-w) !important;
  height: auto !important;
  aspect-ratio: 2 / 3 !important;          /* â†ã“ã‚ŒãŒæ±ºå®šæ‰“ */
  border-radius: var(--shuffle-r) !important;
  background: url("cards/back.png") center / cover no-repeat !important;
}

/* é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼ˆflyï¼‰ã‚‚åŒã˜æ¯”ç‡ã§çµ±ä¸€ */
.fly{
  width: calc(var(--shuffle-w) * 0.78) !important;
  height: auto !important;
  aspect-ratio: 2 / 3 !important;
  border-radius: calc(var(--shuffle-r) * 0.95) !important;
  background: url("cards/back.png") center / cover no-repeat !important;
}
.deck, .fly{
  background-size: contain !important;  /* â†åˆ‡ã‚Œãªã„ */
  background-color: rgba(0,0,0,.18);   /* ä½™ç™½ãŒå‡ºãŸæ™‚ã‚‚ç¶ºéº— */
}
/* ================================
   ğŸ“± Mobileæœ€é©åŒ–ï¼šã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼†3æšå¼•ã
   ================================ */

/* ã¾ãšã¯PC/å…±é€šã®åŸºæº–ï¼ˆè§¦ã‚‹ã®ã¯ã“ã“ã ã‘ã§ã‚‚OKï¼‰ */
:root{
  --shuffle-w: 220px;  /* PCã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¹… */
}

/* 3æšå¼•ãï¼šé‡ãªã‚Šã®åŸå› ã¯ã€Œã‚«ãƒ¼ãƒ‰ãŒå¤§ãã™ãã€orã€ŒtcardãŒä¼¸ã³ã¦ã‚‹ã€ãªã®ã§ã€
   ã‚°ãƒªãƒƒãƒ‰ã®å„åˆ—ã‚’â€œå¿…ãšå‡ç­‰â€ã«ã—ã¦ã€ç”»åƒå¹…ã‚’vwã§å›ºå®š */
.cardsGrid.three{
  grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
  gap: 12px !important;
}
.cardsGrid.three .tcard{
  width: 100%;
  min-width: 0; /* â† ã“ã‚ŒãŒãªã„ã¨ä¸­èº«ã§æ¨ªã«åºƒãŒã£ã¦é‡ãªã‚‹ã“ã¨ãŒã‚ã‚‹ */
}
.cardsGrid.three .cardImg{
  width: 100% !important;
  max-width: 100% !important;
  height: auto;
}

/* ---- ãƒ¢ãƒã‚¤ãƒ«æœ¬ç•ªèª¿æ•´ ---- */
@media (max-width: 520px){
  /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚«ãƒ¼ãƒ‰ãŒå¤§ãã™ãã‚‹å•é¡Œ */
  :root{
    --shuffle-w: 150px; /* â†æºå¸¯ã¯å°ã•ã‚ã« */
  }

  /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç®±ã‚‚é€£å‹•ã—ã¦ç¸®ã‚ã‚‹ */
  .shuffleArea{
    height: calc(var(--shuffle-w) * 1.5 + 60px) !important;
    min-height: calc(var(--shuffle-w) * 1.5 + 60px) !important;
  }

  /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼†é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼šæ¯”ç‡ã¯ç¶­æŒã—ãŸã¾ã¾ç¸®å° */
  .deck{
    width: var(--shuffle-w) !important;
    aspect-ratio: 2 / 3 !important;
  }
  .fly{
    width: calc(var(--shuffle-w) * 0.78) !important;
    aspect-ratio: 2 / 3 !important;
  }

  /* 3æšå¼•ãï¼šçµ¶å¯¾ã«é‡ãªã‚‰ãªã„ã‚µã‚¤ã‚ºè¨­è¨ˆï¼ˆ3æš=å„1/3å¹…ï¼‰ */
  .cardsGrid.three{
    gap: 8px !important;
  }

  /* ç”»åƒã‚’vwåŸºæº–ã§å›ºå®šï¼ˆç”»é¢å¹…ã«å¯¾ã—ã¦å¸¸ã«åã¾ã‚‹ï¼‰ */
  .cardsGrid.three .cardImg{
    width: 28vw !important;      /* â† ã“ã“ã‚’ 26ã€œ30 ã§èª¿æ•´ */
    max-width: 28vw !important;
  }
  /* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ã—ãŸã„å ´åˆï¼ˆä»»æ„ã€‚ä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰ */
  .cardsGrid.three .tcard:nth-child(2) .cardImg{
    width: 30vw !important;
    max-width: 30vw !important;
  }

  /* ã‚«ãƒ¼ãƒ‰æ ï¼ˆtcardï¼‰è‡ªä½“ãŒæ¨ªã«åºƒãŒã‚‰ãªã„ã‚ˆã†ã«ä¿é™º */
  .cardsGrid.three .tcard{
    width: 100% !important;
    min-width: 0 !important;
  }
}
/* =====================================
   ğŸ“± Mobileã§ã‚‚3æšæ¨ªä¸¦ã³ã‚’å®ˆã‚‹ï¼ˆé‡ãªã‚Šè§£æ¶ˆï¼‰
   ===================================== */
@media (max-width: 520px){

  /* 3åˆ—ã‚’ç¶­æŒã—ã¤ã¤â€œã¯ã¿å‡ºã—ç¦æ­¢â€ã®åœŸå° */
  .cardsGrid.three{
    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    gap: 8px !important;
    align-items: start;
  }

  /* ã“ã‚ŒãŒè¶…é‡è¦ï¼šä¸­èº«ãŒåŸå› ã§åˆ—å¹…ã‚ˆã‚ŠåºƒãŒã‚‹ã®ã‚’æ­¢ã‚ã‚‹ */
  .tcard,
  .tcardHeader,
  .tcardTitle,
  .tcardBody{
    min-width: 0 !important;
  }
  .tcard{
    width: 100% !important;
    overflow: hidden !important; /* éš£ã«ä¹—ã‚Šä¸Šã’ã‚‹ã®ã‚’ç‰©ç†çš„ã«é˜²ã */
  }

  /* ç”»åƒã¯åˆ—å¹…ã«100%ãƒ•ã‚£ãƒƒãƒˆï¼ˆ=é‡ãªã‚Šã®èµ·ç‚¹ã‚’æ¶ˆã™ï¼‰ */
  .cardsGrid.three .cardImg{
    width: 100% !important;
    max-width: 100% !important;
    height: auto !important;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯â€œç¸¦ç©ã¿â€ã«ã—ã¦æ¨ªã®çªãæŠœã‘ã‚’é˜²ãï¼ˆæ¨ªä¸¦ã³è¡¨ç¤ºã¯ç¶­æŒï¼‰ */
  .tcardHeader{
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 6px !important;
    padding: 10px 10px 8px !important;
  }

  /* ãƒãƒƒã‚¸ã‚‚æŠ˜ã‚Šè¿”ã—å¯ã« */
  .badge{
    font-size: 11px !important;
    padding: 5px 8px !important;
    max-width: 100% !important;
    white-space: normal !important;
  }

  /* YES/NO ãƒ”ãƒ«ãŒä¸»çŠ¯ï¼šå°ã•ãï¼†æŠ˜ã‚Šè¿”ã—ï¼†åˆ—ã‹ã‚‰å‡ºãªã„ */
  .ynRow{
    margin-top: 8px !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  .yn{
    font-size: 12px !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
    max-width: 100% !important;
    white-space: normal !important;       /* â†æŠ˜ã‚Šè¿”ã™ */
    overflow-wrap: anywhere !important;   /* â†ä¿ç•™/æ—¥æœ¬èªã§ã‚‚çªãæŠœã‘ãªã„ */
  }

  /* æ–‡å­—é‡ã‚‚å°‘ã—ç· ã‚ã¦â€œ3æšæ¨ªâ€ã®å“ã‚’ä¿ã¤ */
  .tcardBody{
    padding: 0 10px 10px !important;
    font-size: 12px !important;
    line-height: 1.55 !important;
  }
  .tcardTitle .name{ font-size: 13px !important; }
  .tcardTitle .sub{ font-size: 11px !important; }

  /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãŒæ¨ªã«é•·ã„ã¨æŠ¼ã—å‡ºã™ã®ã§å°‘ã—å°ã•ã */
  .kw{
    font-size: 11px !important;
    padding: 5px 8px !important;
    max-width: 100% !important;
  }
}
.coreText{
  margin-top:6px;
  font-size:14px;
  line-height:1.7;
  font-weight:600;
  color:rgba(255,255,255,.95);
}



  </style>
</head>
<body>
  <div style="position:fixed;bottom:12px;right:12px;z-index:9999;
background:#000a;border:1px solid #fff3;color:#fff;padding:8px 10px;border-radius:10px;
font:12px/1.2 ui-sans-serif;">
  VERSION: 2025-12-24-1
</div>

  <div class="app">
    <header>
      <div class="title">
        <h1>Angelique Tarotï¼ˆCSVèª­ã¿è¾¼ã¿ç‰ˆï¼‰</h1>
        <p>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰10å€‹ / ï¼ˆã‚³ã‚¢ãƒ»æ³¨é‡ˆãƒ»å¤©ä½¿ï¼‰/ Yesãƒ»Noï¼ˆæ­£é€†ï¼‰ã‚’è¡¨ç¤ºã€‚</p>
      </div>
    </header>

    <div class="panel topGrid">
      <div>
        <div id="creatorOnly"></div>
         <div class="fileBox">
          <div>
            <div style="font-weight:800; font-size:14px; margin-bottom:6px;">â‘  CSVã‚’èª­ã¿è¾¼ã‚€</div>
             <input id="csvFile" type="file" accept=".csv,text/csv" />
             <div class="hint">
              â€» æ–‡å­—åŒ–ã‘å¯¾ç­–ï¼šCSVã¯<strong>UTF-8ï¼ˆã§ãã‚Œã°UTF-8 with BOMï¼‰</strong>ã§ä¿å­˜ã€‚<br>
              â€» èª­ã¿è¾¼ã‚“ã CSVã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆlocalStorageï¼‰ã•ã‚Œã€æ¬¡å›ã‚‚ä½¿ãˆã¾ã™ã€‚
             </div>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;">
             <button class="secondary" id="btnUseSaved">ä¿å­˜æ¸ˆã¿CSVã‚’ä½¿ã†</button>
             <button class="secondary" id="btnClearSaved">ä¿å­˜ã‚’æ¶ˆã™</button>
           </div>
         </div>
        <div class="status" id="status"> Angelique Tarot ã¯ã™ãã«ä½¿ãˆã¾ã™ âœ¨</div>
        </div>
       </div>

      <div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div style="font-weight:800; font-size:14px;">â‘¡ å¼•ãæ–¹ã‚’é¸ã¶</div>

          <div class="drawMode">
            <label class="chip">
              <input type="radio" name="drawMode" value="1" checked />
              <div>
                <strong>1æšï¼ˆãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ï¼‰</strong><br />
                <span>ã„ã¾ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
              </div>
            </label>

            <label class="chip">
              <input type="radio" name="drawMode" value="3" />
              <div>
                <strong>3æšï¼ˆæ·±æ˜ã‚Šï¼‰</strong><br />
                <span>éå» / ç¾åœ¨ / æœªæ¥</span>
              </div>
            </label>
          </div>

          <div class="btnRow">
            <button id="btnDraw">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
          </div>

          <div class="small">
            â€»é€†ä½ç½®ã¯ã‚«ãƒ¼ãƒ‰ã ã‘é€†ã«è¡¨ç¤ºã€‚<br>
            â€»æœ¬æ–‡ï¼ˆã‚³ã‚¢/æ³¨é‡ˆ/å¤©ä½¿/è¡Œå‹•ï¼‰ã¯<strong>æ­£ä½ç½®ã‚’ãƒ¡ã‚¤ãƒ³</strong>ã«è¡¨ç¤ºï¼ˆã‚ãªãŸã®æ–¹é‡ï¼‰ã€‚<br>
            â€»é€†ä½ç½®æ–‡ã¯æŠ˜ã‚ŠãŸãŸã¿ã§ç¢ºèªã§ãã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>

  


    <div class="panel stage">
      <div class="stageTop">
        <div class="stageTitle">
          <h2>ã‚·ãƒ£ãƒƒãƒ•ãƒ«</h2>
          <p>æ¼”å‡º â†’ å¼•ã„ãŸçµæœã‚’è¡¨ç¤º</p>
        </div>
        <div class="small" id="deckInfo">ãƒ‡ãƒƒã‚­ï¼šæœªèª­ã¿è¾¼ã¿</div>
      </div>

      <div class="shuffleArea" id="shuffleArea">
        <div class="deck"></div>
        <div class="fly"></div><div class="fly"></div><div class="fly"></div>
        <div class="fly"></div><div class="fly"></div><div class="fly"></div>
      </div>

      <div id="result" style="margin-top:14px;">
        <div class="empty">
          ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚<br>
          â‘  CSVã‚’èª­ã¿è¾¼ã‚€ â†’ â‘¡ 1æš/3æšã‚’é¸ã¶ â†’ â‘¢ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const STORAGE_KEY = "angelique_tarot_csv_rows_v2";
    let cards = [];
    const IS_CREATOR = true; // â† ã‚ãªãŸã®PCã¯ true / å…¬é–‹ç”¨ã¯ false

function applyCreatorMode(){
  const el = document.getElementById("creatorOnly");
  if(!IS_CREATOR && el){
    el.style.display = "none";
  }
}


  
    const elFile = document.getElementById("csvFile");
    const elStatus = document.getElementById("status");
    const elDeckInfo = document.getElementById("deckInfo");
    const elShuffleArea = document.getElementById("shuffleArea");
    const elResult = document.getElementById("result");

    document.getElementById("btnDraw").addEventListener("click", onDraw);
    document.getElementById("btnUseSaved").addEventListener("click", useSaved);
    document.getElementById("btnClearSaved").addEventListener("click", clearSaved);
    elFile.addEventListener("change", onPickFile);
const CSV_PATH = "data/deck.csv"; 

function guessDelimiterFromText(text){
  const firstLine = (text || "").split(/\r?\n/)[0] || "";
  const tabCount = (firstLine.match(/\t/g) || []).length;
  const commaCount = (firstLine.match(/,/g) || []).length;
  // ã‚¿ãƒ–ã®æ–¹ãŒå¤šã‘ã‚Œã°TSVã€ãã‚Œä»¥å¤–ã¯CSV
  return tabCount > commaCount ? "\t" : ",";
}

async function loadBundledCsv(){
  console.log("loadBundledCsv called");
  setStatus("åŒæ¢±CSVã‚’èª­ã¿è¾¼ã¿ä¸­...");
  console.log("CSV_PATH =", CSV_PATH);

  try{
    const res = await fetch(CSV_PATH, { cache: "no-store" });
    if(!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);
    const text = await res.text();

    const delim = guessDelimiterFromText(text);
    console.log("guessed delimiter =", JSON.stringify(delim));

const results = Papa.parse(text, {
  header: true,
  skipEmptyLines: true,
  delimiter: delim
});


// ===== Column1ã€œ è¡Œã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ =====
if (results.meta?.fields?.[0]?.toLowerCase() === "column1") {
  console.log("Dummy header detected. Re-parsing CSV...");
  results.data.shift();              // ãƒ€ãƒŸãƒ¼è¡Œã‚’æ¨ã¦ã‚‹
}
// ========================================

    console.log("Papa meta.fields:", results.meta?.fields);
    console.log("First row sample:", results.data?.[0]);

   const rows = (results.data || [])
  .map(normalizeRow)
  .filter(r => r && r.id);


    console.log("normalized rows:", rows.length, rows[0]);

    if(!rows.length){
      setStatus("åŒæ¢±CSVã®èª­ã¿è¾¼ã¿ã¯ã§ããŸãŒã€id ãŒå–ã‚Œã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å/åŒºåˆ‡ã‚Šã®å¯èƒ½æ€§ï¼‰ã€‚");
      return;
    }

    if(!validateCards(rows)){
      setStatus("åŒæ¢±CSVã®å¿…é ˆåˆ—ï¼ˆid,name_ja,name_en,imageï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
      return;
    }

    cards = rows;
    setDeckInfo();
    setStatus(`åŒæ¢±CSV èª­ã¿è¾¼ã¿å®Œäº†ï¼š${cards.length}æšã€‚å¼•ã‘ã¾ã™ã€‚`);
    showReady();
  }catch(e){
    console.error(e);
    setStatus("åŒæ¢±CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆConsoleå‚ç…§ï¼‰ã€‚");
  }
}


function boot(){
   applyCreatorMode();   // â† ã“ã‚Œã‚’è¿½åŠ 
  loadBundledCsv(); // â˜…åŒæ¢±CSVã‚’è‡ªå‹•ã§èª­ã‚€
}
boot();



    function setStatus(msg){ elStatus.textContent = msg; }
    function setDeckInfo(){
      elDeckInfo.textContent = cards.length ? `ãƒ‡ãƒƒã‚­ï¼š${cards.length}æš èª­ã¿è¾¼ã¿æ¸ˆã¿` : "ãƒ‡ãƒƒã‚­ï¼šæœªèª­ã¿è¾¼ã¿";
    }


function pick(row, key){
  // å®Œå…¨ä¸€è‡´
  if (row[key] != null) return row[key];

  // trim/BOMã‚’ç„¡è¦–ã—ã¦ä¸€è‡´ã•ã›ã‚‹
  const want = normalizeKey(key);
  const hit = Object.keys(row).find(k => normalizeKey(k) === want);
  return hit ? row[hit] : "";
}

function normalizeKey(s){
  return (s ?? "")
    .toString()
    .replace(/^\uFEFF/, "")
    .trim()
    .toLowerCase();
}





function pickAny(row, candidates){
  for(const c of candidates){
    const v = pick(row, c);
    if(v != null && String(v).trim() !== "") return String(v).trim();
  }
  return "";
}



function normalizeImagePath(s){
  return (s ?? "")
    .toString()
    .replace(/^\uFEFF/, "")
    .trim()
    .replace(/^\/+/, "")
    .replace(/\\/g, "/");   // Windowsã® \ ã‚’ / ã«
}

function normalizeRow(row){
  // ã‚­ãƒ¼æ­£è¦åŒ–ï¼ˆBOM/ç©ºç™½/å¤§å°ï¼‰
  const norm = (s) => (s ?? "").toString().replace(/^\uFEFF/, "").trim().toLowerCase();

  // row ã‹ã‚‰ key ã‚’å¤§å°/BOMç„¡è¦–ã§å–ã‚‹
  const get = (key) => {
    const want = norm(key);
    const hit = Object.keys(row).find(k => norm(k) === want);
    return hit ? String(row[hit] ?? "").trim() : "";
  };

  // 1) é€šå¸¸ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆid, arcana, ... imageï¼‰ã§æ¥ãŸå ´åˆ
  const idNormal = get("id");
  if (idNormal) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒæ··ã˜ã‚‹ä¿é™º
    if (idNormal.toLowerCase() === "id") return null;

    return {
      id: idNormal,
      arcana: get("arcana"),
      suit: get("suit"),
      number: get("number"),
      name_ja: get("name_ja"),
      name_en: get("name_en"),
      element: get("element"),
      polarity: get("polarity"),
      yes_no_upright: get("yes_no_upright"),
      yes_no_reversed: get("yes_no_reversed"),
      timing: get("timing"),
      themes: get("themes"),
      keywords_upright: get("keywords_upright"),
      keywords_reversed: get("keywords_reversed"),
      core_upright: get("core_upright"),
      interpretation_upright: get("interpretation_upright"),
      angel_upright: get("angel_upright"),
      action_upright: get("action_upright"),
      core_reversed: get("core_reversed"),
      interpretation_reversed: get("interpretation_reversed"),
      angel_reversed: get("angel_reversed"),
      action_reversed: get("action_reversed"),
      image: normalizeImagePath(get("image")),
    };
  }

  // 2) Column1ã€œColumn23 ã§æ¥ãŸå ´åˆ
  const getCol = (n) => {
    const want = "column" + n;
    const hit = Object.keys(row).find(k => norm(k) === want);
    return hit ? String(row[hit] ?? "").trim() : "";
  };

  const idCol = getCol(1);
  if (!idCol || idCol.toLowerCase() === "id") return null;

  return {
    id: idCol,
    arcana: getCol(2),
    suit: getCol(3),
    number: getCol(4),
    name_ja: getCol(5),
    name_en: getCol(6),
    element: getCol(7),
    polarity: getCol(8),
    yes_no_upright: getCol(9),
    yes_no_reversed: getCol(10),
    timing: getCol(11),
    themes: getCol(12),
    keywords_upright: getCol(13),
    keywords_reversed: getCol(14),
    core_upright: getCol(15),
    interpretation_upright: getCol(16),
    angel_upright: getCol(17),
    action_upright: getCol(18),
    core_reversed: getCol(19),
    interpretation_reversed: getCol(20),
    angel_reversed: getCol(21),
    action_reversed: getCol(22),
    image: normalizeImagePath(getCol(23)),
  };
}



function validateCards(list){
  // id ã•ãˆã‚ã‚Œã°OKï¼ˆimageã¯ç„¡ãã¦ã‚‚å‹•ãï¼‰
  const bad = list.find(r => !r.id);
  return !bad;
}



 function onPickFile(){
  const file = elFile.files?.[0];
  if(!file) return;

  setStatus("CSVã‚’èª­ã¿è¾¼ã¿ä¸­...");

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const text = reader.result?.toString() || "";
      const delim = guessDelimiterFromText(text);
      console.log("file guessed delimiter =", JSON.stringify(delim));

const results = Papa.parse(text, {
  header: true,
  skipEmptyLines: true,
  delimiter: delim
});



// ===== Column1ã€œ è¡Œã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ =====
if (results.meta?.fields?.[0]?.toLowerCase() === "column1") {
  console.log("Dummy header detected. Re-parsing CSV...");
  results.data.shift();
}
// ========================================




      const rows = (results.data || [])
  .map(normalizeRow)
  .filter(r => r && r.id);


      if(!rows.length){
        setStatus("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆåŒºåˆ‡ã‚Š/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªï¼‰ã€‚");
        return;
      }
      if(!validateCards(rows)){
        setStatus("å¿…é ˆåˆ—ï¼ˆid,name_ja,name_en,imageï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
        return;
      }

      cards = rows;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
      setDeckInfo();
      setStatus(`èª­ã¿è¾¼ã¿å®Œäº†ï¼š${cards.length}æšã€‚å¼•ã‘ã¾ã™ã€‚`);
      showReady();
    }catch(e){
      console.error(e);
      setStatus("èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ã€‚CSVå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  reader.onerror = () => {
    setStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  };
  reader.readAsText(file, "utf-8");
}

    function useSaved(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(!saved){
        setStatus("ä¿å­˜æ¸ˆã¿CSVãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšCSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      try{
        const rows = JSON.parse(saved);
        if(!Array.isArray(rows) || !rows.length){
          setStatus("ä¿å­˜æ¸ˆã¿CSVãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚ã„ã£ãŸã‚“æ¶ˆã—ã¦èª­ã¿è¾¼ã¿ç›´ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        cards = rows;
        setDeckInfo();
        setStatus(`ä¿å­˜æ¸ˆã¿CSVã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼š${cards.length}æšã€‚`);
        showReady();
      }catch(e){
        setStatus("ä¿å­˜æ¸ˆã¿CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚æ¶ˆã—ã¦èª­ã¿è¾¼ã¿ç›´ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function clearSaved(){
  localStorage.removeItem(STORAGE_KEY);
  cards = [];
  setDeckInfo();
  setStatus("ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
  elResult.innerHTML = `<div class="empty">
    ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚<br>
    â‘  CSVã‚’èª­ã¿è¾¼ã‚€ â†’ â‘¡ 1æš/3æšã‚’é¸ã¶ â†’ â‘¢ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€
  </div>`;
}


    function getDrawCount(){
      const el = document.querySelector('input[name="drawMode"]:checked');
      return el ? parseInt(el.value, 10) : 1;
    }

    function showReady(){
      elResult.innerHTML = `<div class="empty">
        æº–å‚™OKã€‚<br>
        â‘¡ 1æš/3æšã‚’é¸ã¶ â†’ â‘¢ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€
      </div>`;
    }

    function startShuffle(){ elShuffleArea.classList.add("shuffling"); }
    function stopShuffle(){ elShuffleArea.classList.remove("shuffling"); }
    function randInt(n){ return Math.floor(Math.random() * n); }

    function drawUnique(count){
  const used = new Set();
  const picked = [];
  while(picked.length < count){
    const idx = randInt(cards.length);
    if(used.has(idx)) continue;
    used.add(idx);
    const card = cards[idx];
    const isReversed = Math.random() < 0.5;
    picked.push({ card, isReversed });
  }
  return picked;
}


    async function onDraw(){
      if(!cards.length){
        setStatus("å…ˆã«CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      const count = getDrawCount();
      setStatus(`ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­â€¦ï¼ˆ${count}æšå¼•ãï¼‰`);
      startShuffle();
      await new Promise(r => setTimeout(r, 1400));
      stopShuffle();

      const picked = drawUnique(count);
      console.log("picked[0] raw =", picked[0]);
console.log("picked[0] json =", JSON.stringify(picked[0], null, 2));
console.log("picked[0].card json =", JSON.stringify(picked[0]?.card, null, 2));

 


     const labels3 = ["éå»", "ç¾åœ¨", "æœªæ¥"];
const gridClass = count === 1 ? "cardsGrid single" : "cardsGrid three";

elResult.innerHTML = `
  <div class="${gridClass}">
    ${picked.map((p, i) =>
      renderCard(p.card, p.isReversed, count === 3 ? labels3[i] : "ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«")
    ).join("")}
  </div>
`;

      setStatus(`çµæœè¡¨ç¤ºï¼š${count}æšå¼•ãã€‚`);
    }

    // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š| åŒºåˆ‡ã‚Šã§æœ€å¤§10å€‹ ---
    function splitKeywords(str, limit=10){
      const raw = (str ?? "").toString().trim();
      if(!raw) return [];
      return raw.split("|").map(s => s.trim()).filter(Boolean).slice(0, limit);
    }
function strengthenCore(core, themes){
  const c = (core ?? "").toString().trim();
  const t = (themes ?? "").toString().trim();

  // æ—¢ã«ååˆ†é•·ã„ãªã‚‰ãã®ã¾ã¾
  if(c.length >= 55) return c;

  // ãƒ†ãƒ¼ãƒãŒã‚ã‚‹ãªã‚‰1è¡Œæ·»ãˆã¦åšã¿ã‚’ä½œã‚‹ï¼ˆâ†ã“ã“ãŒå¿…ãšæ–‡å­—åˆ—æ‰±ã„ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
  const themeLine = t ? `ç„¦ç‚¹ï¼š${t}ã€‚` : `ç„¦ç‚¹ï¼šã„ã¾ä¸€ç•ªå¤§äº‹ãªæ„Ÿè¦šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã€‚`;

  return [
    `çŠ¶æ³ï¼š${c || "æµã‚Œã®ç¯€ç›®ã«ã„ã¾ã™ã€‚"}`,
    themeLine,
    `æ–¹å‘æ€§ï¼šç„¡ç†ã«æ€¥ãŒãšã€ã§ãã‚‹ä¸€æ­©ã«å…‰ã‚’å½“ã¦ã¦ã€‚`
  ].join(" ");
}

    function metaLine(card){
      const parts = [];
      if(card.arcana) parts.push(`åŒºåˆ†:${card.arcana}`);
      if(card.suit) parts.push(`ã‚¹ãƒ¼ãƒˆ:${card.suit}`);
      if(card.number) parts.push(`ç•ªå·:${card.number}`);
      if(card.element) parts.push(`å…ƒç´ :${card.element}`);
      if(card.polarity) parts.push(`æ¥µæ€§:${card.polarity}`);
      if(card.timing) parts.push(`æ™‚æœŸ:${card.timing}`);
           return parts.join(" / ");
    }


 // é€†ä½ç½®ã®æ™‚ã¯é€†ä½ç½®ã ã‘è¡¨ç¤ºï¼ˆæ­£ä½ç½®ã¯è¡¨ç¤ºã—ãªã„ï¼‰
function renderCard(card, isReversed, positionLabel){

  // --- ãƒ‡ãƒ¼ã‚¿å–å¾— ---
  const kw = splitKeywords(isReversed ? card.keywords_reversed : card.keywords_upright, 10);
  const core = (isReversed ? card.core_reversed : card.core_upright) || "";
  const interpretation = (isReversed ? card.interpretation_reversed : card.interpretation_upright) || "";
  const angel = (isReversed ? card.angel_reversed : card.angel_upright) || "";
  const action = (isReversed ? card.action_reversed : card.action_upright) || "";
  const yn = (isReversed ? card.yes_no_reversed : card.yes_no_upright) || "";
  const meta = metaLine(card);
  const themes = (card.themes ?? "").toString().trim();

  // --- è¡¨ç¤ºãƒ–ãƒ­ãƒƒã‚¯ ---
  const coreBlock = `
    <div class="line">
      <span class="k">è¦ç‚¹ï¼š</span>
      <div class="coreText">${escapeHtml(strengthenCore(core, themes))}</div>
    </div>
  `;

  const interpretationBlock = `
    <div class="line"><span class="k">èª­ã¿è§£ãï¼š</span>${escapeHtml(interpretation)}</div>
  `;

  const angelBlock = `
    <div class="line"><span class="k">å¤©ä½¿ã‹ã‚‰ã®è¨€è‘‰ï¼š</span>${escapeHtml(angel)}</div>
  `;

  const actionBlock = `
    <div class="line"><span class="k">ä»Šæ—¥ã®ä¸€æ­©ï¼š</span>${escapeHtml(action)}</div>
  `;

  // --- ä½ç½®åˆ¥å‡ºã—åˆ†ã‘ ---
  let mainMessageHTML = "";

  if(positionLabel === "éå»"){
    mainMessageHTML = coreBlock;
  }else if(positionLabel === "ç¾åœ¨"){
    mainMessageHTML = coreBlock + interpretationBlock;
  }else if(positionLabel === "æœªæ¥"){
    mainMessageHTML = angelBlock + actionBlock;
  }else{
    // 1æšå¼•ã
    mainMessageHTML = coreBlock + interpretationBlock + angelBlock + actionBlock;
  }

  // --- HTMLè¿”å´ ---
  return `
    <div class="tcard">
      <div class="tcardHeader">
        <div class="tcardTitle">
          <div class="pos">${escapeHtml(positionLabel)}</div>
          <div class="name">${escapeHtml(card.name_ja)} <span class="sub">(${escapeHtml(card.name_en)})</span></div>
          <div class="sub">${escapeHtml(meta)}</div>
          ${themes ? `<div class="sub">ãƒ†ãƒ¼ãƒï¼š${escapeHtml(themes)}</div>` : ``}
        </div>
        <div class="badge ${isReversed ? "rev" : "up"}">${isReversed ? "é€†ä½ç½®" : "æ­£ä½ç½®"}</div>
      </div>

      <div class="tcardVisual">
        <img class="cardImg ${isReversed ? "reversed" : ""}"
          src="${cardImageUrl(card.image)}"
          alt="${escapeHtml(card.name_ja)}"
          onerror="handleCardImgError(this)"
        />
      </div>

      ${yn ? `
        <div class="ynRow">
          <div class="yn ${isReversed ? "rev" : "up"}">YES / NOï¼š${escapeHtml(yn)}</div>
        </div>` : ``}

      <div class="tcardBody">
        <div class="line">
          <span class="k">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆ${isReversed ? "é€†" : "æ­£"}ï¼‰ï¼š</span>
         <div class="kwWrap">
  ${kw.length
    ? kw.map(w => `<span class="kw ${isReversed ? "rev" : "up"}">${escapeHtml(w)}</span>`).join("")
    : `<span class="small">ï¼ˆãªã—ï¼‰</span>`
  }
</div>

        </div>
        ${mainMessageHTML}
      </div>
    </div>
  `;
}

function cardImageUrl(image){
  let raw = (image ?? "").toString().trim();
  if(!raw) return "cards/back.png"; // â† public ã‚’å¤–ã™

  raw = raw
    .replace(/^\uFEFF/, "")
    .replace(/^"+|"+$/g, "")
    .replace(/^'+|'+$/g, "")
    .replace(/^\/+/, "")
    .replace(/\\/g, "/");

  // æ‹¡å¼µå­ãŒç„¡ã„ãªã‚‰ png ã‚’ã¾ãšè©¦ã™ï¼ˆwebpã¯ onerror ã§æ‹¾ã†ï¼‰
  if(!/\.(png|jpg|jpeg|webp)$/i.test(raw)){
    raw += ".png";
  }

  // ã™ã§ã«çµ¶å¯¾URLãªã‚‰ãã®ã¾ã¾
  if(/^https?:\/\//i.test(raw)) return raw;

  // "cards/" ã§å§‹ã¾ã‚‹ãªã‚‰ãã®ã¾ã¾
  if(raw.startsWith("cards/")) return encodeURI(raw);

  // ãã‚Œä»¥å¤–ã¯ cards/ é…ä¸‹ã«å¯„ã›ã‚‹
  return encodeURI("cards/" + raw);
}

function handleCardImgError(img){
  const tried = parseInt(img.dataset.tried || "0", 10);

  // ã¾ãšã€å…ƒã® src ã‹ã‚‰ã€Œæ‹¡å¼µå­ã ã‘ã€å·®ã—æ›¿ãˆã¦è©¦ã™
  const src = img.getAttribute("src") || "";
  const base = src.replace(/\.(webp|png|jpg|jpeg)(\?.*)?$/i, ""); // æœ«å°¾æ‹¡å¼µå­ã‚’é™¤å»
  const query = (src.match(/(\?.*)$/) || [""])[0];

  const exts = ["webp", "png", "jpg", "jpeg"];

  // ã™ã§ã« back.png ãªã‚‰çµ‚äº†ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
  if(src.includes("back.png")) return;

  if(tried < exts.length){
    img.dataset.tried = String(tried + 1);
    img.src = `${base}.${exts[tried]}${query}`;
    return;
  }

  // æœ€å¾Œã®ç ¦ï¼šè£é¢
  img.src = "public/cards/back.png";
}


// ---- HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ----
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

  </script>
</body>
</html>


























